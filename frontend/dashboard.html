<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pipeline Dashboard</title>
    <!-- bootstrap CDN for responsive layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous">
    <style>
        :root{--bg:#111;--fg:#fff;--box:#1e1e1e;--accent:#4caf50;}
        body{font-family:Arial;background:var(--bg);color:var(--fg);padding:30px;transition:.2s}
        body.light{--bg:#fafafa;--fg:#111;--box:#fff;--accent:#007bff}
        .box{background:var(--box);padding:20px;border-radius:8px;margin-bottom:20px;}
        h1,h2{color:var(--accent)}
        canvas{max-width:100%}
        #themeToggle{float:right;padding:6px 10px;border:1px solid var(--fg);border-radius:6px;cursor:pointer;background:transparent;color:var(--fg)}
        .controls{margin-bottom:16px}
        select{padding:6px;border-radius:4px;border:1px solid #ccc}
    </style>
</head>
<body>
    <h1>Pipeline Dashboard <button id="themeToggle">ðŸŒ™</button></h1>
    <div class="controls">
        <label for="metricSelect">Metric:</label>
        <select id="metricSelect">
            <option value="count">Count</option>
            <option value="avg_views">Avg Views</option>
            <option value="avg_likes">Avg Likes</option>
        </select>
    </div>
    <div id="stats" class="box">Loading stats...</div>
    <div id="catChartBox" class="box">
        <h2 id="chartTitle">Category Distribution</h2>
        <canvas id="catChart"></canvas>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartInstance = null;
        function applyTheme(t){
            if(t==='light') document.body.classList.add('light'); else document.body.classList.remove('light');
            localStorage.setItem('dashTheme', t);
            document.getElementById('themeToggle').textContent = document.body.classList.contains('light') ? 'ðŸŒ™' : 'â˜€ï¸';
        }
        document.getElementById('themeToggle').addEventListener('click', ()=>{
            applyTheme(document.body.classList.contains('light') ? 'dark' : 'light');
        });
        const savedTheme = localStorage.getItem('dashTheme');
        if(savedTheme) applyTheme(savedTheme); else applyTheme('dark');

        async function loadStats() {
            const div = document.getElementById('stats');
            try {
                const res = await fetch('http://127.0.0.1:8000/stats');
                if (!res.ok) throw new Error(`status ${res.status}`);
                const js = await res.json();
                div.innerHTML = `
                    <h2>Prediction Table</h2>
                    <p>Total rows: ${js.prediction_rows}</p>
                    <p>Last pipeline run: ${js.last_run || 'unknown'}</p>
                `;

                if (Array.isArray(js.category_stats)) {
                    setupChart(js.category_stats);
                    renderTable(js.category_stats);
                    document.getElementById('metricSelect').disabled = false;
                }
            } catch (e) {
                div.innerHTML = `<p>Error loading stats: ${e.message || e}</p>`;
                console.error(e);
            }
        }

        function setupChart(stats){
            const metric = document.getElementById('metricSelect').value;
            const labels = stats.map(c=>c.name);
            const data = stats.map(c=>c[metric] || 0);
            const titleMap = {count:'Rows per Category', avg_views:'Average Views', avg_likes:'Average Likes'};
            document.getElementById('chartTitle').textContent = titleMap[metric];
            const ctx = document.getElementById('catChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type:'bar',
                data:{labels, datasets:[{label:titleMap[metric], data, backgroundColor:'rgba(75, 192, 192, 0.6)'}]},
                options:{responsive:true, scales:{y:{beginAtZero:true}}}
            });
        }

        function renderTable(stats){
            const container = document.getElementById('stats');
            let html = '<h3>Category breakdown</h3><table class="table table-sm table-striped"><thead><tr><th>Category</th><th>Count</th><th>Avg Views</th><th>Avg Likes</th></tr></thead><tbody>';
            stats.forEach(c=>{
                html += `<tr><td>${c.name}</td><td>${c.count}</td><td>${c.avg_views.toFixed(2)}</td><td>${c.avg_likes.toFixed(2)}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML += html;
        }

        document.getElementById('metricSelect').addEventListener('change', async ()=>{
            const res = await fetch('http://127.0.0.1:8000/stats');
            if (!res.ok) return;
            const js = await res.json();
            if(Array.isArray(js.category_stats)) setupChart(js.category_stats);
        });

        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>